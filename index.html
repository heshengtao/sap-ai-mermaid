<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mermaid AI Editor Pro (Offline)</title>
<style>
:root {
  --primary: #2563eb;
  --bg-app: #f8fafc;
  --bg-panel: #ffffff;
  --border: #e2e8f0;
  --text-main: #1e293b;
  --header-h: 56px;
}

body, html {
  margin: 0;
  padding: 0;
  height: 100%;
  font-family: 'Inter', -apple-system, sans-serif;
  background-color: var(--bg-app);
  color: var(--text-main);
  overflow: hidden;
}

#app { display: flex; flex-direction: column; height: 100vh; }

/* Header */
header {
  height: var(--header-h);
  background: var(--bg-panel);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 20px;
  z-index: 10;
}
.brand { font-weight: 700; font-size: 18px; display: flex; align-items: center; gap: 8px; }
.brand svg { color: var(--primary); }
.toolbar { display: flex; gap: 10px; align-items: center; }

/* Main */
main { flex: 1; display: flex; overflow: hidden; }

.pane-editor {
  width: 400px;
  max-width: 50%;
  display: flex;
  flex-direction: column;
  border-right: 1px solid var(--border);
  background: var(--bg-panel);
}

.pane-preview {
  flex: 1;
  background-color: #f1f5f9;
  background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
  background-size: 20px 20px;
  position: relative;
  overflow: hidden;
  display: flex;
  justify-content: center;
  align-items: center;
  transition: background-color 0.3s ease;
}

@media (max-width: 768px) {
  main { flex-direction: column; }
  .pane-editor { width: 100%; height: 40%; max-width: 100%; border-right: none; border-bottom: 1px solid var(--border); }
  .pane-preview { height: 60%; }
}

/* UI Elements */
.btn {
  height: 32px; padding: 0 12px; border-radius: 6px;
  border: 1px solid var(--border); background: white;
  cursor: pointer; display: inline-flex; align-items: center; gap: 6px;
}
.btn:hover { background: #f8fafc; }

.select-input {
  height: 32px; border-radius: 6px; border: 1px solid var(--border);
  padding: 0 8px; outline: none;
}

#ace-editor { flex: 1; width: 100%; }
#editor-header {
  height: 36px; background: #f8fafc; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; padding: 0 12px;
  font-size: 12px; font-weight: 600; color: #64748b;
}

.zoom-controls {
  position: absolute; bottom: 24px; right: 24px;
  display: flex; flex-direction: column; gap: 6px;
  background: white; padding: 6px; border-radius: 8px;
  box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
  border: 1px solid var(--border); z-index: 50;
}
.zoom-btn {
  width: 32px; height: 32px; border: none; background: transparent;
  color: #64748b; border-radius: 4px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
}
.zoom-btn:hover { background: #f1f5f9; color: var(--primary); }

#status-toast {
  position: absolute; top: 70px; left: 50%; transform: translateX(-50%);
  background: #334155; color: white; padding: 8px 16px;
  border-radius: 20px; font-size: 13px; opacity: 0; pointer-events: none;
  transition: opacity 0.3s; z-index: 100;
}
#error-log {
  background: #fee2e2; color: #b91c1c; font-size: 12px; padding: 8px;
  border-top: 1px solid #fecaca; display: none; max-height: 80px; overflow-y: auto;
  font-family: monospace;
}
</style>

<!-- 1. 引入 Ace Editor (也可以下载到本地) -->
<script src="ace.js"></script>
<!-- 2. 引入 svg-pan-zoom (也可以下载到本地) -->
<script src="svg-pan-zoom.min.js"></script>
<!-- 3. 【关键修改】引入本地的 Mermaid 单文件 -->
<script src="mermaid.min.js"></script>

</head>
<body>

<div id="app">
  <header>
    <div class="brand">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M12 8v8M8 12h8"></path></svg>
      <span>Mermaid Studio</span>
    </div>
    <div class="toolbar">
      <select id="theme-select" class="select-input">
        <option value="default">Theme: Default</option>
        <option value="neutral">Theme: Neutral</option>
        <option value="dark">Theme: Dark</option>
        <option value="forest">Theme: Forest</option>
        <option value="base">Theme: Base</option>
      </select>
      <button class="btn" onclick="window.exporter.downloadSVG()">SVG</button>
      <button class="btn" onclick="window.exporter.downloadPNG()">PNG</button>
    </div>
  </header>

  <main>
    <div class="pane-editor">
      <div id="editor-header">EDITOR <span id="sync-dot" style="color:var(--primary);margin-left:5px;opacity:0">●</span></div>
      <div id="ace-editor"></div>
      <div id="error-log"></div>
    </div>
    <div class="pane-preview">
      <div id="graph-inner" style="width:100%;height:100%;display:flex;justify-content:center;align-items:center;">
        <span style="color:#94a3b8">Waiting for code...</span>
      </div>
      <div class="zoom-controls">
        <button class="zoom-btn" onclick="window.ui.zoomIn()" title="Zoom In"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg></button>
        <button class="zoom-btn" onclick="window.ui.zoomOut()" title="Zoom Out"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"></line></svg></button>
        <button class="zoom-btn" onclick="window.ui.reset()" title="Reset"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M8 16H3v5"></path></svg></button>
      </div>
    </div>
  </main>
  
  <div id="status-toast"></div>
  <div id="sandbox" style="position:fixed; top:-9999px; left:-9999px; visibility:hidden;"></div>
</div>

<!-- 【关键修改】不再使用 type="module"，普通的 script 标签即可 -->
<script>
/* 
   注意：现在 mermaid 是全局变量 window.mermaid
   不再需要 import mermaid from ...
*/

/* ========== 1. 导出模块 ========== */
window.exporter = {
  async getCleanSVG() {
    const rawSvg = document.querySelector('#graph-inner svg');
    if (!rawSvg) return null;
    const clone = rawSvg.cloneNode(true);
    
    const viewport = clone.querySelector('.svg-pan-zoom_viewport');
    if (viewport) {
        const children = Array.from(viewport.childNodes);
        children.forEach(child => clone.appendChild(child));
        clone.removeChild(viewport);
    }
    clone.removeAttribute('style');
    clone.removeAttribute('class');
    clone.removeAttribute('width');
    clone.removeAttribute('height');
    
    const isDark = currentTheme === 'dark';
    clone.style.backgroundColor = isDark ? '#1a1a1a' : '#ffffff';

    const sandbox = document.getElementById('sandbox');
    sandbox.innerHTML = '';
    sandbox.appendChild(clone);
    await new Promise(r => setTimeout(r, 10));
    
    const bbox = clone.getBBox(); 
    const padding = 20;
    const x = bbox.x - padding;
    const y = bbox.y - padding;
    const w = bbox.width + padding * 2;
    const h = bbox.height + padding * 2;
    
    clone.setAttribute('viewBox', `${x} ${y} ${w} ${h}`);
    clone.setAttribute('width', w);
    clone.setAttribute('height', h);
    
    sandbox.innerHTML = '';
    return { xml: new XMLSerializer().serializeToString(clone), width: w, height: h };
  },

  async downloadSVG() {
    const data = await this.getCleanSVG();
    if(!data) return;
    const blob = new Blob([data.xml], {type: 'image/svg+xml;charset=utf-8'});
    this.save(blob, 'diagram.svg');
  },

  async downloadPNG() {
    const data = await this.getCleanSVG();
    if(!data) return;
    const img = new Image();
    const url = URL.createObjectURL(new Blob([data.xml], {type: 'image/svg+xml;charset=utf-8'}));
    
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const scale = 2; 
      canvas.width = data.width * scale;
      canvas.height = data.height * scale;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = (currentTheme === 'dark') ? '#1a1a1a' : '#ffffff';
      ctx.fillRect(0,0, canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      
      canvas.toBlob(blob => {
        this.save(blob, 'diagram.png');
        URL.revokeObjectURL(url);
      }, 'image/png');
    };
    img.src = url;
  },

  save(blob, name) {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = name;
    a.click();
    window.ui.toast('Exported Successfully');
  }
};

/* ========== 2. UI与主题 ========== */
const editor = ace.edit("ace-editor");
editor.setTheme("ace/theme/chrome");
editor.session.setMode("ace/mode/markdown");
editor.setFontSize(14);
editor.setShowPrintMargin(false);
editor.renderer.setShowGutter(false);

let panZoom = null;
let currentTheme = 'default';

const themeBgMap = {
  default: '#f1f5f9',
  neutral: '#f4f4f4',
  dark: '#1a1a1a',
  forest: '#e8f5e9',
  base: '#ffffff'
};

window.ui = {
  toastVal: document.getElementById('status-toast'),
  errorLog: document.getElementById('error-log'),
  container: document.getElementById('graph-inner'),
  previewPane: document.querySelector('.pane-preview'),
  syncDot: document.getElementById('sync-dot'),
  
  toast(msg) {
    this.toastVal.textContent = msg;
    this.toastVal.style.opacity = 1;
    setTimeout(() => this.toastVal.style.opacity = 0, 2000);
  },
  
  zoomIn() { if(panZoom) panZoom.zoomIn(); },
  zoomOut() { if(panZoom) panZoom.zoomOut(); },
  reset() { if(panZoom) { panZoom.resetZoom(); panZoom.center(); } }
};

/* ========== 3. 渲染核心 ========== */
const baseConfig = {
  startOnLoad: false,
  securityLevel: 'loose',
  flowchart: { htmlLabels: false },
  gantt: { axisFormat: '%m/%d/%Y' }
};

// 全局 mermaid 对象已由 mermaid.min.js 提供
mermaid.initialize({ ...baseConfig, theme: currentTheme });

async function render(code) {
  if(!code || code.length < 5) return;
  window.ui.errorLog.style.display = 'none';
  
  try {
    await mermaid.parse(code); 
    
    mermaid.initialize({ ...baseConfig, theme: currentTheme });
    
    const id = 'mermaid-' + Date.now();
    const { svg } = await mermaid.render(id, code);
    window.ui.container.innerHTML = svg;
    
    const svgEl = window.ui.container.querySelector('svg');
    svgEl.style.width = '100%';
    svgEl.style.height = '100%';
    svgEl.style.maxWidth = 'none'; 
    
    if(panZoom) panZoom.destroy();
    panZoom = svgPanZoom(svgEl, {
      zoomEnabled: true,
      controlIconsEnabled: false,
      fit: true,
      center: true,
      minZoom: 0.1,
      maxZoom: 10
    });
    
    window.ui.previewPane.style.backgroundColor = themeBgMap[currentTheme] || '#f1f5f9';
    if(currentTheme === 'dark') {
       window.ui.previewPane.style.backgroundImage = 'radial-gradient(#444 1px, transparent 1px)';
    } else {
       window.ui.previewPane.style.backgroundImage = 'radial-gradient(#cbd5e1 1px, transparent 1px)';
    }

  } catch (e) {
    if(!code.endsWith(';')) { 
      window.ui.errorLog.style.display = 'block';
      window.ui.errorLog.textContent = e.message.split('\n')[0];
    }
  }
}

let timer;
editor.session.on('change', () => {
  if(timer) clearTimeout(timer);
  timer = setTimeout(() => {
    const val = editor.getValue();
    const code = extractCode(val);
    if(code) render(code);
  }, 500);
});

document.getElementById('theme-select').onchange = (e) => {
  currentTheme = e.target.value;
  const val = editor.getValue();
  const code = extractCode(val);
  if(code) render(code);
};

/* ========== 4. 工具函数 ========== */
function extractCode(text) {
  if(!text) return '';
  const match = text.match(/```mermaid\s*([\s\S]*?)```/);
  if(match) return match[1].trim();
  const openMatch = text.match(/```mermaid\s*([\s\S]*)/);
  if(openMatch) return openMatch[1].trim();
  if(text.trim().match(/^(graph|flowchart|sequenceDiagram|classDiagram|gantt|pie|gitGraph)/)) {
    return text.trim();
  }
  return '';
}

/* ========== 5. WebSocket (带容错) ========== */
let ws;
function initWs() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  // 如果是 file:// 打开，没有 host，直接跳过连接
  if(location.protocol === 'file:') return;
  
  ws = new WebSocket(`${proto}//${location.host}/ws`);
  ws.onopen = () => ws.send(JSON.stringify({type:'get_messages'}));
  ws.onmessage = (e) => {
    try {
      const d = JSON.parse(e.data);
      if(d.type === 'messages_update' || d.type === 'broadcast_messages') {
        processMsg(d.data.messages);
      }
    } catch(err){}
  };
  ws.onclose = () => setTimeout(initWs, 2000);
}

let lastCode = '';
function processMsg(list) {
  if(!list || !list.length) return;
  const last = list.filter(m => m.role === 'assistant').pop();
  if(!last) return;
  
  const raw = last.pure_content || last.content || '';
  const pure = extractCode(raw);
  
  if(pure && pure !== lastCode) {
    lastCode = pure;
    const current = editor.getValue();
    if(pure.length > current.length || !current.startsWith(pure.substring(0, 10))) {
        editor.setValue(pure, 1);
        window.ui.syncDot.style.opacity = 1;
        setTimeout(() => window.ui.syncDot.style.opacity = 0, 500);
    }
  }
}

initWs();
</script>
</body>
</html>

